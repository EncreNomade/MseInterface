var __SOL = {
    "rigidBodies":[{"name":"Name","imagePath":"Decors.jpg","origin":{"x":0,"y":0},"polygons":[[{"x":0.7733958959579468,"y":0.014228800311684608},{"x":0.7706458568572998,"y":0.016978800296783447},{"x":0.7658959031105042,"y":0.01797880232334137},{"x":0.7537498474121094,"y":0.012874851003289223}],[{"x":0.7537498474121094,"y":0.012874851003289223},{"x":0.7933958768844604,"y":0.013478804379701614},{"x":0.7818958759307861,"y":0.014228800311684608},{"x":0.7733958959579468,"y":0.014228800311684608}],[{"x":0.7933958768844604,"y":0.013478804379701614},{"x":0.7888959050178528,"y":0.01772880181670189},{"x":0.7841458916664124,"y":0.01747880131006241},{"x":0.7818958759307861,"y":0.014228800311684608}],[{"x":0.3332500457763672,"y":0.24062490463256836},{"x":0.2914999723434448,"y":0.2648749351501465},{"x":0.24474996328353882,"y":0.27962493896484375},{"x":0.47849997878074646,"y":0.15412485599517822}],[{"x":0.47849997878074646,"y":0.15412485599517822},{"x":0.3930000364780426,"y":0.24037490785121918},{"x":0.3332500457763672,"y":0.24062490463256836}],[{"x":0.24474996328353882,"y":0.27962493896484375},{"x":0.21424993872642517,"y":0.3098749816417694},{"x":0.047499995678663254,"y":0.4073749780654907},{"x":0.002250000834465027,"y":0.4073749780654907}],[{"x":0.002250000834465027,"y":0.4073749780654907},{"x":0.002250000834465027,"y":0.4698749780654907},{"x":-0.0017501069232821465,"y":0.47016650438308716},{"x":-0.0027501434087753296,"y":0.005124717019498348}],[{"x":-0.0027501434087753296,"y":0.005124717019498348},{"x":0.7182497978210449,"y":0.013374852016568184},{"x":0.47849997878074646,"y":0.15412485599517822},{"x":0.24474996328353882,"y":0.27962493896484375},{"x":0.002250000834465027,"y":0.4073749780654907}],[{"x":-0.0027501434087753296,"y":0.005124717019498348},{"x":0.7259998321533203,"y":0.012874851003289223},{"x":0.7182497978210449,"y":0.013374852016568184}],[{"x":-0.0027501434087753296,"y":0.005124717019498348},{"x":0.942229688167572,"y":0.001405799761414528},{"x":0.7537498474121094,"y":0.012874851003289223},{"x":0.7259998321533203,"y":0.012874851003289223}],[{"x":0.942229688167572,"y":0.001405799761414528},{"x":0.9226459264755249,"y":0.013228833675384521},{"x":0.87149977684021,"y":0.013374852016568184},{"x":0.7933958768844604,"y":0.013478804379701614},{"x":0.7537498474121094,"y":0.012874851003289223}],[{"x":-0.0027501434087753296,"y":0.005124717019498348},{"x":1.0002087354660034,"y":-6.356852827593684E-4},{"x":0.9671459197998047,"y":0.0012287944555282593},{"x":0.942229688167572,"y":0.001405799761414528}],[{"x":1.0002087354660034,"y":-6.356852827593684E-4},{"x":0.9918959736824036,"y":0.012978833168745041},{"x":0.9691458940505981,"y":0.012728797271847725},{"x":0.9671459197998047,"y":0.0012287944555282593}],[{"x":1.0002087354660034,"y":-6.356852827593684E-4},{"x":1.0009585618972778,"y":0.4172496795654297},{"x":0.9901251792907715,"y":0.41808298230171204},{"x":0.9918959736824036,"y":0.012978833168745041}]],"circles":[],"shapes":[{"type":"POLYGON","vertices":[{"x":0.002250000834465027,"y":0.4698749780654907},{"x":0.002250000834465027,"y":0.4073749780654907},{"x":0.047499995678663254,"y":0.4073749780654907},{"x":0.21424993872642517,"y":0.3098749816417694},{"x":0.24474996328353882,"y":0.27962493896484375},{"x":0.2914999723434448,"y":0.2648749351501465},{"x":0.3332500457763672,"y":0.24062490463256836},{"x":0.3930000364780426,"y":0.24037490785121918},{"x":0.47849997878074646,"y":0.15412485599517822},{"x":0.7182497978210449,"y":0.013374852016568184},{"x":0.7259998321533203,"y":0.012874851003289223},{"x":0.7537498474121094,"y":0.012874851003289223},{"x":0.7658959031105042,"y":0.01797880232334137},{"x":0.7706458568572998,"y":0.016978800296783447},{"x":0.7733958959579468,"y":0.014228800311684608},{"x":0.7818958759307861,"y":0.014228800311684608},{"x":0.7841458916664124,"y":0.01747880131006241},{"x":0.7888959050178528,"y":0.01772880181670189},{"x":0.7933958768844604,"y":0.013478804379701614},{"x":0.87149977684021,"y":0.013374852016568184},{"x":0.9226459264755249,"y":0.013228833675384521},{"x":0.942229688167572,"y":0.001405799761414528},{"x":0.9671459197998047,"y":0.0012287944555282593},{"x":0.9691458940505981,"y":0.012728797271847725},{"x":0.9918959736824036,"y":0.012978833168745041},{"x":0.9901251792907715,"y":0.41808298230171204},{"x":1.0009585618972778,"y":0.4172496795654297},{"x":1.0002087354660034,"y":-6.356852827593684E-4},{"x":-0.0027501434087753296,"y":0.005124717019498348},{"x":-0.0017501069232821465,"y":0.47016650438308716}]}]}],"dynamicObjects":[]};

// mse.src.addSource('box2d', './support/Box2dWeb-2.1.a.3.min.js', 'script', true);
var Poubelle = function(){
    mse.Game.call(this, {fillback:true});  
    
    mse.src.addSource('sprite', 'games/Poubelle.png', 'img', true);
    mse.src.addSource('batiments', 'games/Batiments.png', 'img', true);
    mse.src.addSource('metro', 'games/Metro.png', 'img', true);
    mse.src.addSource('police', 'games/police.png', 'img', true);
    mse.src.addSource('bosse', 'games/bosse.png', 'img', true);
    mse.src.addSource('voiture', 'games/Voiture.png', 'img', true);
    mse.src.addSource('buisson', 'games/Buisson.png', 'img', true);
    mse.src.addSource('up', 'games/up.png', 'img', true);
    mse.src.addSource('down', 'games/down.png', 'img', true);
    mse.src.addSource('left', 'games/left.png', 'img', true);
    mse.src.addSource('right', 'games/right.png', 'img', true);

    this.width = 640;
    this.height = 480;
    
    var dirBouton = {
        up: new mse.Image(null, {pos:[this.width-80,this.height-70]}, 'up'),
        down: new mse.Image(null, {pos:[this.width-130,this.height-70]}, 'down'),
        left: new mse.Image(null, {pos:[30,this.height-70]}, 'left'),
        right: new mse.Image(null, {pos:[30+70,this.height-70]}, 'right')
    };
    this.currScene = new mdj.Scene(this, 7138, 3353);
    
    // init b2World
    this.b2World = new Box2D.Dynamics.b2World(
       new Box2D.Common.Math.b2Vec2(0, 40)    //gravity
    ,  true                 //allow sleep
    );
    this.b2World.data = {
        sceneW: this.width, 
        sceneH: this.height,
        totalW: this.currScene.width,
        totalH: this.currScene.height        
    };
    this.inTheAir = true;
    var contactListener = new GameContactListener(this);
    contactListener.BeginContact = function(contact){
        this.game.inTheAir = false;
        
        if(contact.GetNext()){            
            var nameAnext = contact.GetNext().GetFixtureA().GetBody().GetUserData();
            var nameBnext = contact.GetNext().GetFixtureB().GetBody().GetUserData();
            if(nameAnext == 'poly1' || nameBnext == 'poly1') return;
        }
        
        var x = contact.GetManifold().m_localPlaneNormal.x;
        var y = contact.GetManifold().m_localPlaneNormal.y; 
        // var normal = 180*Math.atan2(x/y) / Math.PI;
        
        var normal = 180*Math.atan(x/y);
        normal = Math.abs(normal) / Math.PI;
        
        this.game.lastEdgeAngle = normal;
    };
    contactListener.EndContact = function(){this.game.inTheAir = true;};
    this.b2World.SetContactListener(contactListener);
    createGround(this.b2World);
    
    // init poubelle
    this.poubelleMod = new mdj.Box2DModel(190, 340, 0, this.b2World, 95, 93, 
        {density: 1, friction: 0.2, restitution: 0.08}
    );
    this.poubelleMod.setCollisionBox(0, 0, 80, 90);
    this.poubelleMod.body.SetUserData('Poubelle');
    
    this.poubelleVue = new mdj.Sprite(this.poubelleMod, 'sprite', {w:126,h:110,sx:0,sy:0,sw:1008,sh:550});
    this.poubelleVue.addAnime("normal", new mdj.AnimationSprite(this.poubelleVue, [0,1,2,3,4], 0, 4));    
    this.poubelleVue.addAnime("speedDown", new mdj.AnimationSprite(this.poubelleVue, [8,9,10], 0, 4));
    this.poubelleVue.addAnime("speedUp", new mdj.AnimationSprite(this.poubelleVue, [16,17,18,19], 0, 4));
    this.poubelleVue.addAnime("chuteAvt", new mdj.AnimationSprite(this.poubelleVue, [24,25,26,27,28,29], 1, 4));
    this.poubelleVue.addAnime("chuteArr", new mdj.AnimationSprite(this.poubelleVue, [32,33,34,35,36,37,38,39], 1, 4));
    
    var persoLayer = new mdj.ObjLayer("perso", this.currScene, 3, 0, 0);
    persoLayer.addObj(this.poubelleVue);
    
    this.camera = new mdj.Camera(this.width, this.height, this.currScene, this.poubelleMod);
    
    // init police car && colision    
    var perduCB = new mse.Callback(function(e){
        if(this.state != 'CHUTE'){
            this.chuteDir='chuteAvt';
            this.declencherChute();
        }
    }, this);
    
    var policeLayer = new mdj.ObjLayer("police", this.currScene, 4, 0, 0);
    var policeMod = new mdj.BoxModel(5380+179, 3180, 174, 92);
    policeMod.setCollisionBox(50,10,120,92);
    var colliDetector = new mdj.CollisionDetector(this.poubelleMod);
    colliDetector.register('policeCol', policeMod, perduCB);
    var policeVue = new mdj.Image(policeMod, 'police');
    policeLayer.addObj(policeVue);
    
    var rougeM = new mdj.BoxModel(3420, 2245, 188, 68, 0.53);
    colliDetector.register('voitureCol',rougeM, perduCB);
    policeLayer.addObj(new mdj.Image(rougeM, 'voiture'));
    
    this.msg = {
        "INIT": "Clique pour jouer.",
        "WIN": "Bravo!!! Tu as gagn√©.",
        "LOSE": "Perdu..."
    };
    this.state = "INIT";
    
    this.init = function() {
        
        // MseConfig.iOS = true;
        this.state = "INIT";
        
        this.getEvtProxy().addListener('keydown', this.keyDowncb);    
        this.getEvtProxy().addListener('keyup', this.keyUpcb);
        
        this.getEvtProxy().addListener('gestureStart', this.startGestCb);
        this.getEvtProxy().addListener('gestureUpdate', this.updateGestCb);
        this.getEvtProxy().addListener('gestureEnd', this.endGestCb);
        
        
        if(!this.fond) {
            this.fond = generateFond(this, this.b2World);
            var fondLayer =  new mdj.ObjLayer("fond", this.currScene, 1);
            fondLayer.fond = this.fond.canvas;
            fondLayer.draw = function(ctx, sx, sy, sw, sh){
                ctx.drawImage(this.fond, sx, sy, sw, sh, sx, sy, sw, sh);
            }
        }
        if(!this.premierPlan){
            this.premierPlan = (function(parent, w, h){
                var canvas = document.createElement("canvas");
                canvas.width = w;
                canvas.style.width = w
                canvas.height = h;
                canvas.style.height = h;
                
                var ctx = canvas.getContext('2d');
                var metro = new mse.Sprite(parent, {pos:[0,0], size:[183, 104]}, 'metro', 183, 104, 0   , 0 , 183, 104);
                metro.draw(ctx, 6555, 3155);
                ctx.fillStyle = 'black';
                ctx.fillRect(6555,3155+104, 600, 400);
                
                return canvas;
            })(this, this.b2World.data.totalW, this.b2World.data.totalH);
            var layer =  new mdj.ObjLayer("metro", this.currScene, 5);
            layer.img = this.premierPlan;
            layer.draw = function(ctx, sx, sy, sw, sh){
                ctx.drawImage(this.img, sx, sy, sw, sh, sx, sy, sw, sh);
            }
        }
        this.lastEdgeAngle = null;
        this.dir = {
            changeSpeed: 'no',
            changeAngle: 'no'
        };
        
        
        // re-init body
        this.poubelleMod.setPos(260,390);
        this.poubelleMod.body.SetAngle(0);
        this.poubelleMod.body.SetType(Box2D.Dynamics.b2Body.b2_dynamicBody);
        this.poubelleVue.playAnime('normal');
        if(typeof this.currScene.getLayer('black') != 'undefined') this.currScene.getLayer('black').time = 0;
    };
    
    this.mobileLazyInit = function() {
    };
    
    this.logic = function(delta) {
        this.b2World.Step(1 / 60, 10, 10);
        this.b2World.ClearForces();
        
        // Chute test
        if(!this.inTheAir && this.lastEdgeAngle != null && this.state != 'CHUTE'){
            var angle = this.poubelleMod.body.GetAngle();
            angle = angle*180 / Math.PI;
            angle = angle % 360;
            if(angle > 180) angle = 360 - angle;
            else if(angle < -180) angle = -360 - angle;
            
            angle -= this.lastEdgeAngle;
            if(angle > 45 || angle < -45){                
                if(angle > 45) this.chuteDir = 'chuteAvt';
                else this.chuteDir = 'chuteArr';
                this.declencherChute();                
            }
        }  
        
        if(this.state == 'CHUTE'){ // LOSE !
            if(this.chuteTimer < 60){ // wait before lose
                this.chuteTimer++;
            }
            else{
                this.state = 'LOSE';
                this.getEvtProxy().removeListener('keydown', this.keyDowncb);
                this.getEvtProxy().removeListener('keyup', this.keyUpcb);                
                this.getEvtProxy().removeListener('gestureStart', this.startGestCb);
                this.getEvtProxy().removeListener('gestureUpdate', this.updateGestCb);
                this.getEvtProxy().removeListener('gestureEnd', this.endGestCb)
                this.lose();
            }
        }
        else if(this.poubelleMod.getX() > 6660) { // WIN !
            this.state = 'WIN';
            this.getEvtProxy().removeListener('keydown', this.keyDowncb);       
            this.getEvtProxy().removeListener('keyup', this.keyUpcb);
            this.getEvtProxy().removeListener('gestureStart', this.startGestCb);
            this.getEvtProxy().removeListener('gestureUpdate', this.updateGestCb);
            this.getEvtProxy().removeListener('gestureEnd', this.endGestCb)
            this.end();
        }
        
        // Keyboard controle >> speed & angle
        var vel = this.poubelleMod.body.GetLinearVelocity(); // to evaluate speed limit
        if (this.dir.changeSpeed == 'UP' && vel.x < 30 && vel.y < 10)
            this.poubelleMod.body.ApplyImpulse(new Box2D.Common.Math.b2Vec2(5.0, 0),this.poubelleMod.body.GetWorldCenter());
        else if (this.dir.changeSpeed == 'DOWN' && vel.x > 0.3) // reculer est interdit
            this.poubelleMod.body.ApplyImpulse(new Box2D.Common.Math.b2Vec2(-5.0, 0),this.poubelleMod.body.GetWorldCenter());
        if(this.dir.changeAngle == 'LEFT')
            this.poubelleMod.body.SetAngularVelocity(-3.2);
        else if(this.dir.changeAngle == 'RIGHT')
            this.poubelleMod.body.SetAngularVelocity(3.2);
            
        this.currScene.logic(delta);
        
        colliDetector.detect();
    };
    
    this.draw = function(ctx) {
        ctx.save();        
        this.camera.drawScene(ctx);
        if(MseConfig.iOS && this.state != 'CHUTE'){
            for (var i in dirBouton) dirBouton[i].draw(ctx);
        }
        ctx.restore();
    };
    
    this.declencherChute = function(){
        this.state = 'CHUTE';
        this.chuteTimer = 0;
        
        this.poubelleMod.body.SetType(Box2D.Dynamics.b2Body.b2_staticBody);        
        
        if(typeof this.currScene.getLayer('black') == 'undefined')
            var blackLayer =  new mdj.ObjLayer("black", this.currScene, 2);
        else var blackLayer = this.currScene.getLayer('black');
        blackLayer.time = 0;
        blackLayer.draw = function(ctx, sx, sy, sw, sh){
            if(this.parent.game.state == 'CHUTE'){
                var currAnim = this.parent.game.poubelleVue.currAnime;
                var animeChute = this.parent.game.poubelleVue.getAnime(this.parent.game.chuteDir);
                
                ctx.save();   
                ctx.globalAlpha = this.time;
                if(this.time < 1) this.time +=0.05;
                if(currAnim != animeChute){
                    this.parent.game.poubelleVue.playAnime(this.parent.game.chuteDir);
                    var oldAngle = this.parent.game.poubelleMod.getOrientation();
                    if (this.parent.game.chuteDir == 'chuteAvt')
                        this.parent.game.poubelleMod.body.SetAngle(oldAngle - 1);
                    else this.parent.game.poubelleMod.body.SetAngle(oldAngle + 0.7);
                }
                ctx.fillStyle = 'black';
                ctx.fillRect(sx,sy,sw,sh);
                ctx.restore;
            }
        }
    }
    
    this.keyDown = function(e) {
        if(this.state != 'CHUTE'){
            if(this.inTheAir){
                if(e.keyCode == __KEY_RIGHT)
                    this.dir.changeAngle = 'RIGHT';
                else if(e.keyCode == __KEY_LEFT)
                    this.dir.changeAngle = 'LEFT';
            }
            else{
                if(e.keyCode == __KEY_UP && this.dir.changeSpeed != 'UP'){
                    this.dir.changeSpeed = 'UP';
                    this.poubelleVue.playAnime('speedUp');
                }
                else if(e.keyCode == __KEY_DOWN && this.dir.changeSpeed != 'DOWN'){
                    this.dir.changeSpeed = 'DOWN';
                    this.poubelleVue.playAnime('speedDown');                
                }
            }
        }
    };
    
    this.keyDowncb = new mse.Callback(this.keyDown, this);
  
    this.keyUpcb = new mse.Callback(function(e){
        if(this.state != 'CHUTE'){
            if(e.keyCode == __KEY_RIGHT || e.keyCode == __KEY_LEFT){
                this.dir.changeAngle = 'no';
                this.poubelleMod.body.SetAngularVelocity(0);
            }
            else if(e.keyCode == __KEY_UP || e.keyCode == __KEY_DOWN)
                this.dir.changeSpeed = 'no';
            
            this.poubelleVue.playAnime('normal');    
        }
    }, this);
    
    this.gestureMove = function(e){
        var x = e.offsetX;
        var y = e.offsetY;
        
        if(this.state != 'CHUTE'){
            if(this.inTheAir){
                if(dirBouton.right.inObj(x,y))
                    this.dir.changeAngle = 'RIGHT';
                else if(dirBouton.left.inObj(x,y))
                    this.dir.changeAngle = 'LEFT';
            }
            else{
                if(dirBouton.up.inObj(x,y) && this.dir.changeSpeed != 'UP'){
                    this.dir.changeSpeed = 'UP';
                    this.poubelleVue.playAnime('speedUp');
                }
                else if(dirBouton.down.inObj(x,y) && this.dir.changeSpeed != 'DOWN'){
                    this.dir.changeSpeed = 'DOWN';
                    this.poubelleVue.playAnime('speedDown');                
                }
            }
            
        }
    };
    
    this.startGestCb = new mse.Callback(this.gestureMove, this);    
    this.updateGestCb = new mse.Callback(this.gestureMove, this);
    this.endGestCb = new mse.Callback(function(){
        if(this.state != 'CHUTE'){
            if(this.dir.changeAngle != 'no'){
                this.dir.changeAngle = 'no';
                this.poubelleMod.body.SetAngularVelocity(0);
            }
            if(this.dir.changeSpeed != 'no')
                this.dir.changeSpeed = 'no';
                
            this.poubelleVue.playAnime('normal');    
        }
    }, this);
    
    function createGround(b2World){
        var sol = __SOL.rigidBodies[0].polygons;
        var fixDef = new Box2D.Dynamics.b2FixtureDef;
        fixDef.density = 1.0;
        fixDef.friction = 0.3;
        fixDef.restitution = 0.2;
        fixDef.shape = new Box2D.Collision.Shapes.b2PolygonShape;
        var bodyDef = new Box2D.Dynamics.b2BodyDef;
        bodyDef.type = Box2D.Dynamics.b2Body.b2_staticBody;
        
        for(var i=0; i<sol.length; i++) {
            var vertices = [];
            for(var j = sol[i].length-1; j>=0; j--) {
               var x = sol[i][j].x * b2World.data.totalW;
               var y = sol[i][j].y * b2World.data.totalW;
               x /= 30;
               y = ((b2World.data.totalH) - y) / 30;
               
               vertices.push(new Box2D.Common.Math.b2Vec2(x,y));
            }
            fixDef.shape.SetAsArray(vertices);
            bodyDef.position.Set(0,0);
            var body = b2World.CreateBody(bodyDef);
            body.SetUserData('poly'+i);
            body.CreateFixture(fixDef);
        }
    }
    
    function generateFond(parent, b2World) {
        var canvas = document.createElement("canvas");
        canvas.width = b2World.data.totalW;
        canvas.style.width = b2World.data.totalW;
        canvas.height = b2World.data.totalH;
        canvas.style.height = b2World.data.totalH;
        
        var b = [
            new mse.Sprite(parent, {pos:[0,0], size:[389, 412]}, 'batiments', 389, 412, 0   , 588 , 389, 412), 
            new mse.Sprite(parent, {pos:[0,0], size:[297, 545]}, 'batiments', 297, 545, 0   , 0   , 297, 545), 
            new mse.Sprite(parent, {pos:[0,0], size:[297, 586]}, 'batiments', 297, 586, 297 , 0   , 297, 586), 
            new mse.Sprite(parent, {pos:[0,0], size:[297, 584]}, 'batiments', 297, 584, 594 , 0   , 297, 584), 
            new mse.Sprite(parent, {pos:[0,0], size:[534, 459]}, 'batiments', 534, 459, 901 , 0   , 534, 459), 
            new mse.Sprite(parent, {pos:[0,0], size:[355, 458]}, 'batiments', 355, 458, 891 , 542 , 355, 458)
        ];
        var suiteBat = [
            {img: b[5], y: -15},
            {img: b[2], y: 40},
            {img: b[3], y: 220},
            {img: b[1], y: 430},
            {img: b[2], y: 560},
            
            {img: b[4], y: 1110},
            {img: b[3], y: 1080},
            {img: b[1], y: 1140},
            {img: b[2], y: 1400},
            {img: b[1], y: 1800},
            {img: b[5], y: 2050},
            {img: b[3], y: 2100},
            
            
            {img: b[1], y: 2410},
            {img: b[2], y: 2530},
            {img: b[5], y: 2804},
            {img: b[3], y: 2687},
            {img: b[4], y: 2807},
            {img: b[1], y: 2720},
            {img: b[2], y: 2730},
            {img: b[3], y: 2692}
        ];
        var x = 0;
        suiteBat[0].x = -17;
        for(var i = 1; i<suiteBat.length; i++){
            if(i == 5) x += 167;
            else if(i == 12) x += 201;
            x += suiteBat[i-1].img.width;
            suiteBat[i].x = x;
        }
        
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "#131C39";
        ctx.fillRect(20, 0, b2World.data.totalW-50, b2World.data.totalH-20);    
        var buisson = new mse.Sprite(parent, {pos:[0,0], size:[587, 454]}, 'buisson', 587, 454, 0   , 0 , 587, 454);
        buisson.draw(ctx,1400, 1000);
        buisson.draw(ctx,4000, 2500);
        
        for(var i = 0; i<suiteBat.length; i++) {
            suiteBat[i].img.draw(ctx, suiteBat[i].x, suiteBat[i].y);
        }
        
        var sol = __SOL.rigidBodies[0].shapes[0].vertices;
        var H = b2World.data.totalH;
        var W = b2World.data.totalW;
        
        ctx.fillStyle = "black";  
        ctx.beginPath();
        ctx.moveTo(sol[0].x * W, H - sol[0].y * W);
        for(var i = 1; i < sol.length; i++) {
            var x1 = sol[i].x * W;
            var y1 = H - sol[i].y * W;
            ctx.lineTo(x1,y1);            
        }
        ctx.closePath();
        ctx.fill();
        suiteBat[0].img.draw(ctx, suiteBat[0].x, suiteBat[0].y);
        
        var bosse = new mse.Sprite(parent, {pos:[0,0], size:[179*0.9, 92*0.9]}, 'bosse', 179, 92, 0   , 0 , 179, 92);
        bosse.draw(ctx, 5380, 3180);
        ctx.fillStyle = "white";
        ctx.font = '13pt Arial';
        ctx.fillText("Aide l'inspecteur Angelli et Simon.",5,465);
        ctx.fillText("Rejoins la station de M√©tro sans tomb√©",5,485);
        ctx.fillText("pour √©chapper √† la police...",5,505);
        if(!MseConfig.iOS){
            ctx.font = '12pt Arial';    
            ctx.fillText('Controle :',5,530);
            ctx.fillText('Au sol : HAUT / BAS = vitesse',80,530);
            ctx.fillText("En l'air : GAUCHE / DROITE = inclinaison",80,550);
        }
        
        return {'canvas':canvas, 'bat': suiteBat};
    }
};
extend(Poubelle, mse.Game);

// Re implement the B2ContactListener class
var GameContactListener = function(game){
    Box2D.Dynamics.b2ContactListener.call(this)
    this.game = game;
}
extend(GameContactListener, Box2D.Dynamics.b2ContactListener);
$.extend(GameContactListener.prototype, {
    getGame: function(){return this.game;}
});


