
describe("Generate lines | ", function() {
	
	
	var contents = [" \na\n \n  \n\n \n \n\n   \n",
					"\na\n \n[david] a  \n\n \n \n [end]\n  \n \n\n \n",
					"oawipsum \n\n[mike]  lorem f. t, \n[dialogue] h\nhdqln\n",
					"Vivamus tristique, nulla ut dignissim vehicula, massa nisi bibendum diam, non hendrerit enim turpis sed mauris. Nullam pharetra gravida viverra. Donec ultricies, nisi vel sollicitudin gravida, nibh justo posuere erat, vel sagittis nisi ligula ac justo. Praesent consequat odio et eros mollis volutpat. Vivamus risus nibh, interdum non tristique a, congue id arcu. Aliquam euismod consectetur nisl, nec sollicitudin dolor volutpat in. Etiam convallis nisl sed elit aliquet id rutrum purus tincidunt. Praesent fringilla imperdiet commodo. Suspendisse hendrerit purus sed odio interdum venenatis. Fusce vulputate commodo orci, ac sollicitudin eros adipiscing et. Nunc est diam, volutpat auctor luctus vel, auctor ut nulla. Suspendisse a rutrum turpis. Vivamus velit turpis, vehicula vel fringilla eu, fringilla id augue. Cras scelerisque sem a ante venenatis posuere. Nunc quis quam id velit lacinia hendrerit. Nullam eget eleifend justo. Morbi congue interdum erat, nec tincidunt velit volutpat at. Duis adipiscing hendrerit risus quis varius. Proin eu consectetur nisi. Aenean nulla erat, sollicitudin non ornare eu, pharetra sed neque. In hac habitasse platea dictumst. Curabitur varius varius nibh quis laoreet. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Curabitur elit justo, pretium et porttitor ut, dictum non odio. Sed nec orci metus. Nunc nec orci est. Nullam fermentum, arcu at sollicitudin tempor, lacus nibh sollicitudin dolor, quis semper enim felis ac augue. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer justo urna, tincidunt sit amet molestie sit amet, euismod placerat neque. In tempor urna et orci pretium vitae volutpat quam imperdiet. Quisque pretium interdum molestie. Etiam congue nibh magna. Praesent congue metus et ante lobortis accumsan. Duis tempor ipsum eget felis fermentum at adipiscing sapien sollicitudin. In consectetur, nunc eu venenatis pellentesque, velit enim mattis nibh, eget egestas arcu lacus a quam.\n",
					"Ils étaient là. \nÀ moins de cent mètre\nQuatre adolescents qui faisaient régner leur loi au sein du foyer.\nRecroquevillé dans la pénombre d’un porche, L’adolescent contemplait le ballet des lampes torches qui déchiraient la nuit. Des yeux, scrutant le moindre recoin, repoussant les ténèbres de leurs lueurs cyclopes. \nBientôt, ils seraient sur lui. Simon frissonna en songeant à ce qui allait lui arriver. Il savait que Kevin, leur chef, serait sans pitié…  \nIl fallait qu’il leur échappe.Absolument. Et tant pis s’il ne pouvait jamais retourner au foyer.\nLes pas se rapprochaient, de plus en plus. Il pouvait entendre leurs voix à présent.\n[ kevin : neutre ]Trouvez-moi ce sale petit rat ! Il va comprendre qu’on ne peut pas se moquer de nous comme ça [end]\n\n[ fouine : neutre ]Ouaip, on va lui faire sa fête [end]\n\nCa, c’était « La Fouine ».\nDix sept ans, un mètrequatre-vingt, soixante-quinze kilos de violence pure. Une véritable bombe ambploser. Simon se pencha un instant hors de son abri pour évaluer ses chances de leur échapper. \nProche du zéro absolu s’il ne bougeait pas de sa cachette. Un peu plus s’il tentait une sortie. À condition de tomber sur quelqu’un, un adulte qui saurait éloigner ses poursuivants. \n[ simon : neutre ]Tu es prêt ? chuchota-t-il à Dark[end]\n\nDark. Vador. Son rat albinos. Son plus fidèle compagnon depuis un an. \nLe seul en vérité. \nSimon repoussa l’élan de mélancolie qui menaçait de le submerger et enfouit Dark au fond de son sac.\n\nIl passa les lanières autour de ses épaules et s’élança.\nPas de réaction.\nIl s’était i sa vie en dépendait. \nSi la Meute lui tombaitdessus, il était bon pour un passage à tabac dans les règles de l’art. Voilà ce qui se passe lorsque l’on refuse de soumettre aux plus forts.Simon évitait de regarder dans leur direction, les yeux rivés sur les frondaisons du Parc Montsouris. Des arbres, de la pénombre et des milliards de recoins où il pourrait se dissimuler en attendant l’aube. \nS’il atteignait le jardin, il serait sauvé.\nMais, dans sa précipitation, il butta contre le trottoir. Le béton lui arracha une plainte. Un cri minuscule.\n\n[ kevin : neutre ]Il est là [end]\n\n\nPas assez minuscule, visiblement.\nSimon détala tandis que les faisceaux accrochaient sa silhouette. \n\n\n[ kevin : neutre ]Choppez-le ! Faut qu’il comprenne [end]\n\nQue je comprenne quoi ? Qu’il faut se laisser faire ? Pas question !\nIl accéléra. \nIl essayait d’oublier que ses poumons le brûlaient, qu’il était épuisé par cette poursuite qui durait depuis des heures, et surtout que la peur menaçait de le paralyser à tout instant. Il traversa le boulevard, déclenchant le klaxon furieux d’un noctambule égaré. Puis il s’engouffra à l’abri des arbres. Son sac ballotait sur ses épaules et il pensa au pauvre Dark. \nSans réfléchir, il pénétra dans une petite allée. Il dépassa les angles du pavillon météo qui s’élevait dans la pénombre, puis il ralentit sa course. \nPas un bruit.\nRien d’autre que le vent dans les feuilles. \nOù étaient-ils passés ?\nSimon s’arrêta, s’accroupit derrière un banc scarifié de graffitis. \nLà ! Sur sa gauche. \n\n\nIl avait reconnu la démarche chaloupée de la Fouine, les pas lourds de l’Ours – seize ans, un QI inversement proportionnel à sa force - à ses côtés. Les deux autres suivaient la ligne de tramway qui longeait le parc, sur sa droite.\nLe groupe s’était séparé en deux et tentait de l’encercler.\nSimon réfléchit à toute allure. \nLe RER ! \nLa station ne devait être qu’à quelques dizaines de mètres devant lui et, même en ces heures tardives, il y aurait sans doute un peu de monde. \nIl reprit sa progression, lentement, veillant à rester invisible. \nPlus que cinquante mètres.Il entendait déjà le crissement des rames sur les rails.\n\nQuarante.\n\n[ kevin : neutre ]Là sur le pont ! Il essaye de rejoindre la gare [end]\n\n[ simon : neutre ]Merde ! lâcha Simon en reprenant sa course[end]\n\n\nTrente.\n\nMais la meute, galvanisée par la proximité de sa proie, se rapprochait rapidement. Ils avaient de la lumière, ils évitaient les obstacles. \nSurtout ils étaient plus âgés, plus forts alors que lui était éreinté, les jambes écorchées par les ronces, au bord de l’asphyxie.\nLes deux groupes gagnaient insensiblement du terrain. Bientôt ils se rejoindraient et ce serait l’hallali.Simon obliqua brutalement vers le nord pour essayer de rejoindre un bouquet d’arbres denses. Avec un peu de chance, il pourrait les semer. Au pire, il grimperait sur l’un des troncs centenaires. \nIl se précipita dans le bosquet. Les branches basses fouettèrent son visage, lui arrachant des larmes. \nMais il était presqu’à l’abri : l’obscurité était totale. \nIl ignorait vers quoi il courrait mais il s’en fichait. Il accéléra encore et…\nS’effondra brutalement, le souffle coupé, une violente douleur barrant sa poitrine. Il venait de heurter quelque chose de plein fouet. \nAbasourdi, Simon fouilla l’obscurité. Il entendait ses poursuivants battre les talus et les fourrés. \nIl tâtonna un instant dans son sac. \nSa torche.\nUn faible halo de lumière.\nUn grillage. \n\nPiégé !\n\nIl se redressa en grimaçant,  de fer abandonnée.\nLa Petite Ceinture. \nUn éclat de voix derrière lui le fit sursauter.\n[ ours : neutre ]On le tient [end]\n\nSimon fixa le puits de ténèbres qui s’étendait au-delà du grillage.\n[ fouine : neutre ]Alors, t’es enfin prêt à recevoir ta leçon [end]\n\nKevin s’approcha dans la clarté de la lune. Il tendit le bras. Un bruit de ressort. Une lame apparut au bout de sa main. L’adolescent sentait le sang battre contre ses tempes, l’adrénaline inonder son corps. Il voulait gagner du temps pour récupérer. Pour tenter quelque chose. Il se retourna face à ses adversaires.\n[ simon : neutre ]Je n’ai fait que défendre Rachel. Vous n’aviez pas le droit de vous en prendre à elle[end]\n\n[ kevin : neutre ]T’avais qu’à pas te mêler de nos affaires[end]\n\n[ simon : neutre ]Quatre contre un, vous n’êtes que des lâches [end]\n\nSimon avait lancé ça tout en jetant un bref coup d’œil autour de lui. Il avait aperçu la grosse pierre au pied du grillage. Un bon tremplin…Kevin fulminait. \n[ kevin : neutre ]Amenez-le moi [end]\n\nLes trois autres s’élancèrent. Mais, juste avant que leurs mains ne se referment sur lui, il s’était jeté sur le côté. D’une roulade il avait atteint la pierre. Il se redressa d’un bond, prit appui sur le rocher et entreprit l’escalade du grillage.\n[ kevin : neutre ]Il va s’échapper ! Faites quelque chose [end]\n\n[ fouine : neutre ]Mais… Il ne peut pas aller loin, il n’y a rien après[end]\n\nC’était vrai.Il n’y avait plus rien. Rien d’autre qu’un énorme trou de ténèbres. Mais il était trop tard pour reculer. Simon s’élança dans le vide.\n\nÀ SUIVRE...\n"
					];
	var fonts = [ "Arial12px"];
	var widths = [ 400  ];
	var alphabet = [ 'a' , 'lorem ' , 'ipsum ' , 'sit ' , 'amet ' , 'b', 'c' , 'd' ,'e', 'f', 'g', 'h' , 'i' ,'j' , 'k' , 'l' , 'm' , 'n' , 'o' , 'p' , 'q' , 'r' , 's' , 't' , 'u' , 'v' ,'w' , 'l' , ' ' , 'a' , 'lorem ' , 'ipsum ' , 'sit ' , 'amet ' , 'b', 'c' , 'd' ,'e', 'f', 'g', 'h' , 'i' ,'j' , 'k' , 'l' , 'm' , 'n' , 'o' , 'p' , 'q' , 'r' , 's' , 't' , 'u' , 'v' ,'w' , 'l' , ' ' , '\n' , '. ' , ' ' , ' ', ', ' ,"\n[rob] I" ];
	
	var _seed = 123456789512565678;
	var _offset = _seed
	Math.prandom = function(){
		
		var s = _seed + _offset;
		var square = s *s;
		
		_seed = Math.floor( square / 10000 ) % 100000000;
		
		return ( _seed / 100000000 );
	}
	
	generateAleatoireContent = function(){
		var len = Math.floor( Math.prandom() * 200  + 700);
		var r ="";
		var knext = Math.random();
		for( var k = 0 ; k < len ; k ++ ){
			var c = alphabet[ Math.floor( Math.prandom() * alphabet.length ) ];
			if( c.indexOf( "[" ) != -1 && Math.prandom() > 0.3 )
				continue;
			r += c;
		}
		return r+"\n";
	}
	function pseudoFormate( e , breakline ){
					var lines = e.children();
					var s = "";
					if( breakline == null )
						breakline = true;
					for( var l = 0 ; l < lines.length ; l ++ ){
						var line = $( lines[ l ] );
						if( lines[ l ].tagName.toLowerCase() == "paragraphtag" ){
							s += "\n";
							breakline = true;
						}else
						if( !line.hasClass( "textLine" ) ){
							if( line.hasClass( "speaker" ) ){
								s += "[dialogue]"+pseudoFormate( line , breakline );
								breakline = true;
							}else
								continue;
						}else
						if( line.children("p").text().trim() == "" ){ // blank line
							if( breakline ){
								s += "\n";
							}else{
								s += "\n\n";
								breakline = true;
							}
						}else{
							s += line.children("p").text();
							breakline = false;
						}
					}
					return s;
				}
	
	for( var k = 0 ; k < 10 ; k ++ )
		contents.push( generateAleatoireContent() );
	
	var stack;
	
	beforeEach(function() {
	
	});
	afterEach(function() {
		
	});
	
	it("initialisation ..", function() {
	stack = [];
		for( var k = 0 ; k < contents.length ; k ++ ){
			for( var i = 0 ; i < fonts.length ; i ++ ){
				for( var j = 0 ; j < widths.length ; j ++ ){
				
					var res = generateSpeaks( contents[ k ] , fonts[ i ] , widths[ j ] , 18 , false );
					
					stack.push( {
						content_i : k,
						font : fonts[ i ],
						width : widths[ j ],
						lineheight : 18 ,
						res : res
					} );
					
				}
			}
		}
		expect(true).toBe(true);
	});
	
	
	it("correct width", function() {
		for( var k = 0 ; k < stack.length ; k ++ ){
			TextUtil.config( stack[ k ].font );
			var lines = stack[ k ].res;		
			for( var l = 0 ; l < lines.length ; l ++ ){
				var line = $( lines[ l ] );
				if( line.children("p").text().indexOf( " " ) != -1 ) // si il s'agit d'un seul mot super long, on passe le test de débordement de ligne
					expect( TextUtil.measure( line.children("p").text().trim() ) <= stack[ k ].width ).toBe(true);   // notons que le trim est important puisqu'une ligne peut depasser le width avec un caractère non affichable ( expace par exemple )
			}
			
		}
	  });
	
	  it("check the coherence between the string and the DOM article text", function() {
		for( var k = 0 ; k < stack.length ; k ++ ){
			
			var textArticle = pseudoFormate( $("<div/>").append( stack[k].res ) );
			
			var content = contents[ stack[ k ].content_i ];
			
			content = content.replace( /\[end\]/g , "" ).replace( /\[[^\]]*\]/g , "[dialogue]" );  // reformate les dialogues
			
			while( content.match( /(^|\n)(( |\r|\t)+)(\n|$)/ ) )											// cut les espaces qui seront supprimer par le navigateur dans le Dom
				content = content.replace( /\n(( |\r|\t)+)\n/g , "\n\n" ).replace( /^(( |\r|\t)+)\n/g , "\n" ).replace( /\n(( |\r|\t)+)$/g , "\n" );
				
			
			
			expect( content == textArticle ).toBe(true);
		}
	  });
	  
 } );

 
 
 
 